/*
 * myDAC.c
 *
 *  Created on: Jan 28, 2020
 *      Author: kamil
 */

#include "stm32f767xx.h"
#include "myDAC.h"
/*
 * RM - Reference Manual (document you can find on manufacturer's website)
 * In functions below there are fixed values for STM32F767ZI.
 * Other model needs other configuration code according to RM.
 * However the scheme is generally the same.
 */
void myDacInit(void)
{
	myDacRccInit();
	myDacPinInit();
	myDacDmaInit();
	myDacSubInit();
	myDacTimInit();
}

void myDacRun(void)
{
	DAC->CR&=~(DAC_CR_EN1|DAC_CR_TEN1|DAC_CR_DMAEN1);
	DAC->SR|=DAC_SR_DMAUDR1;
	DAC->CR|=DAC_CR_EN1|DAC_CR_TEN1|DAC_CR_DMAEN1;
	DMA1_Stream5->CR|=DMA_SxCR_EN;
	TIM6->CR1|=TIM_CR1_CEN;
}

void myDacStop(void)
{
	TIM6->CR1&=~TIM_CR1_CEN;
	DMA1_Stream5->CR&=~DMA_SxCR_EN;
	DAC->CR&=~(DAC_CR_EN1|DAC_CR_TEN1|DAC_CR_DMAEN1);
	DAC->SR|=DAC_SR_DMAUDR1;
}

void myDacRccInit(void)
{
	RCC->AHB1ENR|=RCC_AHB1ENR_DMA1EN|RCC_AHB1ENR_GPIOAEN;
	RCC->APB1ENR|=RCC_APB1ENR_DACEN|RCC_APB1ENR_TIM6EN;
}

void myDacTimInit(void)			//RM page 1092
{								//I have 96MHz on timer bus
	TIM6->PSC=7;				//96MHz / 8 = 12MHz
	TIM6->ARR=2;				//12MHz / 3 = 4MHz
	TIM6->CR2|=TIM_CR2_MMS_1;	//update event to TRGO
}

void myDacPinInit(void)
{
	GPIOA->MODER|=GPIO_MODER_MODER4_0			//PA4 analog (recommendation from RM)
				|GPIO_MODER_MODER4_1;
}

void myDacDmaInit(void)			//RM page 245
{
	DMA1->HIFCR=0xFFFF;			//clear flags
	DMA1->LIFCR=0xFFFF;
	DMA1_Stream5->PAR=(uint32_t)&DAC->DHR12R1;	//set address peripherial
	DMA1_Stream5->M0AR=(uint32_t)&mySineData;	//set address memory
	DMA1_Stream5->NDTR=1000;					//total number of data items
	DMA1_Stream5->CR|=DMA_SxCR_CHSEL_2			//select request DMA_SxCR ch7
					|DMA_SxCR_CHSEL_1
					|DMA_SxCR_CHSEL_0;
	DMA1_Stream5->CR|=DMA_SxCR_DIR_0
					|DMA_SxCR_CIRC
					|DMA_SxCR_PSIZE_0
					|DMA_SxCR_MINC
					|DMA_SxCR_TCIE;
}

void myDacSubInit(void)			//RM page 486
{
	DAC->CR|=DAC_CR_DMAUDRIE1
			|DAC_CR_BOFF1
	        |DAC_CR_TEN1;
}

//values of sinewave (or any other waveform)
//could also be generated at the very beginning in STM32 with math function
//here I have externally generated values
const uint16_t mySineData[1000]={	//values generated in MS Excel:
	372,							//sine, 1000 samples
	372,							//in range 0.3~3.0V (3V3 reference)
	372,							//frequency is determined by timer
	373,
	373,
	373,
	374,
	374,
	374,
	375,
	376,
	376,
	377,
	378,
	379,
	380,
	381,
	382,
	383,
	384,
	386,
	387,
	388,
	390,
	391,
	393,
	395,
	396,
	398,
	400,
	402,
	404,
	406,
	408,
	410,
	413,
	415,
	417,
	420,
	422,
	425,
	428,
	430,
	433,
	436,
	439,
	442,
	445,
	448,
	451,
	454,
	458,
	461,
	464,
	468,
	471,
	475,
	479,
	482,
	486,
	490,
	494,
	498,
	502,
	506,
	510,
	514,
	519,
	523,
	527,
	532,
	536,
	541,
	546,
	550,
	555,
	560,
	565,
	570,
	575,
	580,
	585,
	590,
	595,
	600,
	606,
	611,
	617,
	622,
	628,
	633,
	639,
	645,
	650,
	656,
	662,
	668,
	674,
	680,
	686,
	692,
	699,
	705,
	711,
	718,
	724,
	730,
	737,
	744,
	750,
	757,
	764,
	770,
	777,
	784,
	791,
	798,
	805,
	812,
	819,
	827,
	834,
	841,
	848,
	856,
	863,
	871,
	878,
	886,
	893,
	901,
	909,
	916,
	924,
	932,
	940,
	948,
	956,
	964,
	972,
	980,
	988,
	996,
	1004,
	1013,
	1021,
	1029,
	1038,
	1046,
	1055,
	1063,
	1072,
	1080,
	1089,
	1097,
	1106,
	1115,
	1124,
	1132,
	1141,
	1150,
	1159,
	1168,
	1177,
	1186,
	1195,
	1204,
	1213,
	1222,
	1232,
	1241,
	1250,
	1259,
	1269,
	1278,
	1287,
	1297,
	1306,
	1316,
	1325,
	1335,
	1344,
	1354,
	1363,
	1373,
	1383,
	1392,
	1402,
	1412,
	1421,
	1431,
	1441,
	1451,
	1461,
	1471,
	1480,
	1490,
	1500,
	1510,
	1520,
	1530,
	1540,
	1550,
	1560,
	1570,
	1581,
	1591,
	1601,
	1611,
	1621,
	1631,
	1641,
	1652,
	1662,
	1672,
	1682,
	1693,
	1703,
	1713,
	1724,
	1734,
	1744,
	1755,
	1765,
	1775,
	1786,
	1796,
	1807,
	1817,
	1828,
	1838,
	1848,
	1859,
	1869,
	1880,
	1890,
	1901,
	1911,
	1922,
	1932,
	1943,
	1953,
	1964,
	1974,
	1985,
	1995,
	2006,
	2016,
	2027,
	2037,
	2048,
	2059,
	2069,
	2080,
	2090,
	2101,
	2111,
	2122,
	2132,
	2143,
	2153,
	2164,
	2174,
	2185,
	2195,
	2206,
	2216,
	2227,
	2237,
	2248,
	2258,
	2268,
	2279,
	2289,
	2300,
	2310,
	2321,
	2331,
	2341,
	2352,
	2362,
	2372,
	2383,
	2393,
	2403,
	2414,
	2424,
	2434,
	2444,
	2455,
	2465,
	2475,
	2485,
	2495,
	2505,
	2515,
	2526,
	2536,
	2546,
	2556,
	2566,
	2576,
	2586,
	2596,
	2606,
	2616,
	2625,
	2635,
	2645,
	2655,
	2665,
	2675,
	2684,
	2694,
	2704,
	2713,
	2723,
	2733,
	2742,
	2752,
	2761,
	2771,
	2780,
	2790,
	2799,
	2809,
	2818,
	2827,
	2837,
	2846,
	2855,
	2864,
	2874,
	2883,
	2892,
	2901,
	2910,
	2919,
	2928,
	2937,
	2946,
	2955,
	2964,
	2972,
	2981,
	2990,
	2999,
	3007,
	3016,
	3024,
	3033,
	3041,
	3050,
	3058,
	3067,
	3075,
	3083,
	3092,
	3100,
	3108,
	3116,
	3124,
	3132,
	3140,
	3148,
	3156,
	3164,
	3172,
	3180,
	3187,
	3195,
	3203,
	3210,
	3218,
	3225,
	3233,
	3240,
	3248,
	3255,
	3262,
	3269,
	3277,
	3284,
	3291,
	3298,
	3305,
	3312,
	3319,
	3326,
	3332,
	3339,
	3346,
	3352,
	3359,
	3366,
	3372,
	3378,
	3385,
	3391,
	3397,
	3404,
	3410,
	3416,
	3422,
	3428,
	3434,
	3440,
	3446,
	3451,
	3457,
	3463,
	3468,
	3474,
	3479,
	3485,
	3490,
	3496,
	3501,
	3506,
	3511,
	3516,
	3521,
	3526,
	3531,
	3536,
	3541,
	3546,
	3550,
	3555,
	3560,
	3564,
	3569,
	3573,
	3577,
	3582,
	3586,
	3590,
	3594,
	3598,
	3602,
	3606,
	3610,
	3614,
	3617,
	3621,
	3625,
	3628,
	3632,
	3635,
	3638,
	3642,
	3645,
	3648,
	3651,
	3654,
	3657,
	3660,
	3663,
	3666,
	3668,
	3671,
	3674,
	3676,
	3679,
	3681,
	3683,
	3686,
	3688,
	3690,
	3692,
	3694,
	3696,
	3698,
	3700,
	3701,
	3703,
	3705,
	3706,
	3708,
	3709,
	3710,
	3712,
	3713,
	3714,
	3715,
	3716,
	3717,
	3718,
	3719,
	3720,
	3720,
	3721,
	3722,
	3722,
	3722,
	3723,
	3723,
	3723,
	3724,
	3724,
	3724,
	3724,
	3724,
	3723,
	3723,
	3723,
	3722,
	3722,
	3722,
	3721,
	3720,
	3720,
	3719,
	3718,
	3717,
	3716,
	3715,
	3714,
	3713,
	3712,
	3710,
	3709,
	3708,
	3706,
	3705,
	3703,
	3701,
	3700,
	3698,
	3696,
	3694,
	3692,
	3690,
	3688,
	3686,
	3683,
	3681,
	3679,
	3676,
	3674,
	3671,
	3668,
	3666,
	3663,
	3660,
	3657,
	3654,
	3651,
	3648,
	3645,
	3642,
	3638,
	3635,
	3632,
	3628,
	3625,
	3621,
	3617,
	3614,
	3610,
	3606,
	3602,
	3598,
	3594,
	3590,
	3586,
	3582,
	3577,
	3573,
	3569,
	3564,
	3560,
	3555,
	3550,
	3546,
	3541,
	3536,
	3531,
	3526,
	3521,
	3516,
	3511,
	3506,
	3501,
	3496,
	3490,
	3485,
	3479,
	3474,
	3468,
	3463,
	3457,
	3451,
	3446,
	3440,
	3434,
	3428,
	3422,
	3416,
	3410,
	3404,
	3397,
	3391,
	3385,
	3378,
	3372,
	3366,
	3359,
	3352,
	3346,
	3339,
	3332,
	3326,
	3319,
	3312,
	3305,
	3298,
	3291,
	3284,
	3277,
	3269,
	3262,
	3255,
	3248,
	3240,
	3233,
	3225,
	3218,
	3210,
	3203,
	3195,
	3187,
	3180,
	3172,
	3164,
	3156,
	3148,
	3140,
	3132,
	3124,
	3116,
	3108,
	3100,
	3092,
	3083,
	3075,
	3067,
	3058,
	3050,
	3041,
	3033,
	3024,
	3016,
	3007,
	2999,
	2990,
	2981,
	2972,
	2964,
	2955,
	2946,
	2937,
	2928,
	2919,
	2910,
	2901,
	2892,
	2883,
	2874,
	2864,
	2855,
	2846,
	2837,
	2827,
	2818,
	2809,
	2799,
	2790,
	2780,
	2771,
	2761,
	2752,
	2742,
	2733,
	2723,
	2713,
	2704,
	2694,
	2684,
	2675,
	2665,
	2655,
	2645,
	2635,
	2625,
	2616,
	2606,
	2596,
	2586,
	2576,
	2566,
	2556,
	2546,
	2536,
	2526,
	2515,
	2505,
	2495,
	2485,
	2475,
	2465,
	2455,
	2444,
	2434,
	2424,
	2414,
	2403,
	2393,
	2383,
	2372,
	2362,
	2352,
	2341,
	2331,
	2321,
	2310,
	2300,
	2289,
	2279,
	2268,
	2258,
	2248,
	2237,
	2227,
	2216,
	2206,
	2195,
	2185,
	2174,
	2164,
	2153,
	2143,
	2132,
	2122,
	2111,
	2101,
	2090,
	2080,
	2069,
	2059,
	2048,
	2037,
	2027,
	2016,
	2006,
	1995,
	1985,
	1974,
	1964,
	1953,
	1943,
	1932,
	1922,
	1911,
	1901,
	1890,
	1880,
	1869,
	1859,
	1848,
	1838,
	1828,
	1817,
	1807,
	1796,
	1786,
	1775,
	1765,
	1755,
	1744,
	1734,
	1724,
	1713,
	1703,
	1693,
	1682,
	1672,
	1662,
	1652,
	1641,
	1631,
	1621,
	1611,
	1601,
	1591,
	1581,
	1570,
	1560,
	1550,
	1540,
	1530,
	1520,
	1510,
	1500,
	1490,
	1480,
	1471,
	1461,
	1451,
	1441,
	1431,
	1421,
	1412,
	1402,
	1392,
	1383,
	1373,
	1363,
	1354,
	1344,
	1335,
	1325,
	1316,
	1306,
	1297,
	1287,
	1278,
	1269,
	1259,
	1250,
	1241,
	1232,
	1222,
	1213,
	1204,
	1195,
	1186,
	1177,
	1168,
	1159,
	1150,
	1141,
	1132,
	1124,
	1115,
	1106,
	1097,
	1089,
	1080,
	1072,
	1063,
	1055,
	1046,
	1038,
	1029,
	1021,
	1013,
	1004,
	996,
	988,
	980,
	972,
	964,
	956,
	948,
	940,
	932,
	924,
	916,
	909,
	901,
	893,
	886,
	878,
	871,
	863,
	856,
	848,
	841,
	834,
	827,
	819,
	812,
	805,
	798,
	791,
	784,
	777,
	770,
	764,
	757,
	750,
	744,
	737,
	730,
	724,
	718,
	711,
	705,
	699,
	692,
	686,
	680,
	674,
	668,
	662,
	656,
	650,
	645,
	639,
	633,
	628,
	622,
	617,
	611,
	606,
	600,
	595,
	590,
	585,
	580,
	575,
	570,
	565,
	560,
	555,
	550,
	546,
	541,
	536,
	532,
	527,
	523,
	519,
	514,
	510,
	506,
	502,
	498,
	494,
	490,
	486,
	482,
	479,
	475,
	471,
	468,
	464,
	461,
	458,
	454,
	451,
	448,
	445,
	442,
	439,
	436,
	433,
	430,
	428,
	425,
	422,
	420,
	417,
	415,
	413,
	410,
	408,
	406,
	404,
	402,
	400,
	398,
	396,
	395,
	393,
	391,
	390,
	388,
	387,
	386,
	384,
	383,
	382,
	381,
	380,
	379,
	378,
	377,
	376,
	376,
	375,
	374,
	374,
	374,
	373,
	373,
	373,
	372,
	372
};
